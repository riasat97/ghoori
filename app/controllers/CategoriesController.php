<?php
header('Content-Type: application/json');

class CategoriesController extends \BaseController {


    public function getCategories(){
        header("content-type : application/javascript");

        $catjson = '[{"catid":"228","catname":"Books & Media","level":1,"children":[{"catid":"85","catname":"Books","level":2,"children":[]},{"catid":"86","catname":"Magazines","level":2,"children":[]},{"catid":"87","catname":"Movies and DVD","level":2,"children":[]},{"catid":"88","catname":"Music","level":2,"children":[]},{"catid":"89","catname":"Stationary","level":2,"children":[]},{"catid":"257","catname":"Comic","level":2,"children":[]}]},{"catid":"229","catname":"Clothing","level":1,"children":[{"catid":"90","catname":"Mens Wear","level":2,"children":[{"catid":"112","catname":"Blazer & Jackets","level":3,"children":[]},{"catid":"113","catname":"Jeans and Pants","level":3,"children":[]},{"catid":"114","catname":"Male Hoodies","level":3,"children":[]},{"catid":"115","catname":"Male Undergarment","level":3,"children":[]},{"catid":"116","catname":"Polo","level":3,"children":[]},{"catid":"117","catname":"Shirt","level":3,"children":[]},{"catid":"118","catname":"Shorts","level":3,"children":[]},{"catid":"119","catname":"Suits","level":3,"children":[]},{"catid":"120","catname":"Sweaters","level":3,"children":[]},{"catid":"121","catname":"T shirts","level":3,"children":[]},{"catid":"357","catname":"Panjabi","level":3,"children":[]}]},{"catid":"91","catname":"Womens Wear","level":2,"children":[{"catid":"122","catname":"Hoodies","level":3,"children":[]},{"catid":"123","catname":"Jacket","level":3,"children":[]},{"catid":"124","catname":"Kurtis","level":3,"children":[]},{"catid":"125","catname":"Lahenga","level":3,"children":[]},{"catid":"126","catname":"Nightwear","level":3,"children":[]},{"catid":"127","catname":"Pants And Tights","level":3,"children":[]},{"catid":"128","catname":"Sarees","level":3,"children":[]},{"catid":"129","catname":"Shrugs","level":3,"children":[]},{"catid":"130","catname":"Sweater","level":3,"children":[]},{"catid":"131","catname":"T shirts tops","level":3,"children":[]},{"catid":"132","catname":"Undergarments","level":3,"children":[]},{"catid":"133","catname":"Unstitched Fabrics","level":3,"children":[]},{"catid":"134","catname":"Women\'s Dresses","level":3,"children":[]}]}]},{"catid":"230","catname":"Computers","level":1,"children":[{"catid":"253","catname":"Computer Accessories","level":2,"children":[{"catid":"334","catname":"Cables","level":3,"children":[]},{"catid":"335","catname":"CD and DVD","level":3,"children":[]},{"catid":"336","catname":"Mouse and keyboard","level":3,"children":[]},{"catid":"337","catname":"Other Computer Accesories","level":3,"children":[]},{"catid":"338","catname":"Software","level":3,"children":[]},{"catid":"339","catname":"Speaker and Headset","level":3,"children":[]},{"catid":"340","catname":"Storage device","level":3,"children":[]},{"catid":"341","catname":"Webcams","level":3,"children":[]}]},{"catid":"254","catname":"Desktop PCs","level":2,"children":[{"catid":"342","catname":"All in one desktop","level":3,"children":[]},{"catid":"343","catname":"Desktop CPUs","level":3,"children":[]},{"catid":"344","catname":"Graphics card","level":3,"children":[]},{"catid":"345","catname":"Monitors","level":3,"children":[]},{"catid":"346","catname":"Motherboard","level":3,"children":[]},{"catid":"347","catname":"Processor","level":3,"children":[]},{"catid":"348","catname":"Servers","level":3,"children":[]}]},{"catid":"255","catname":"Laptops","level":2,"children":[{"catid":"349","catname":"Laptop bags and accesories","level":3,"children":[]},{"catid":"350","catname":"MacBooks","level":3,"children":[]},{"catid":"351","catname":"Net Books","level":3,"children":[]},{"catid":"352","catname":"Note books","level":3,"children":[]},{"catid":"353","catname":"Ultrabooks","level":3,"children":[]}]},{"catid":"256","catname":"Printer & Scanner","level":2,"children":[{"catid":"354","catname":"Printer","level":3,"children":[]},{"catid":"355","catname":"Scanner","level":3,"children":[]},{"catid":"356","catname":"Tools and accesories","level":3,"children":[]}]}]},{"catid":"231","catname":"Electronics","level":1,"children":[{"catid":"115","catname":"Audio","level":2,"children":[{"catid":"135","catname":"HD Multimedia Speakers","level":3,"children":[]},{"catid":"136","catname":"Headphones","level":3,"children":[]},{"catid":"137","catname":"Mp3 Mp4 Player","level":3,"children":[]},{"catid":"138","catname":"Portable Speakers","level":3,"children":[]}]},{"catid":"116","catname":"Camera","level":2,"children":[{"catid":"139","catname":"Camera Accessories","level":3,"children":[]},{"catid":"140","catname":"Digital Camera","level":3,"children":[]},{"catid":"141","catname":"Professional DSLR Camera","level":3,"children":[]},{"catid":"142","catname":"Surveillance","level":3,"children":[]},{"catid":"143","catname":"Video Camera","level":3,"children":[]}]},{"catid":"117","catname":"Gaming","level":2,"children":[{"catid":"144","catname":"Console","level":3,"children":[]},{"catid":"145","catname":"Gaming Accessories","level":3,"children":[]},{"catid":"146","catname":"Nintendo Games","level":3,"children":[]},{"catid":"147","catname":"Pc games","level":3,"children":[]},{"catid":"148","catname":"Playstation games","level":3,"children":[]},{"catid":"149","catname":"Video Games","level":3,"children":[]},{"catid":"150","catname":"Xbox games","level":3,"children":[]}]},{"catid":"118","catname":"Other Electronics","level":2,"children":[]},{"catid":"119","catname":"Power Banks","level":2,"children":[]},{"catid":"120","catname":"Tv & Video","level":2,"children":[{"catid":"151","catname":"3D TVs","level":3,"children":[]},{"catid":"152","catname":"CD DVD Player","level":3,"children":[]},{"catid":"153","catname":"LCD TV","level":3,"children":[]},{"catid":"154","catname":"LED TV","level":3,"children":[]},{"catid":"155","catname":"Portable media devices","level":3,"children":[]},{"catid":"156","catname":"Projectors","level":3,"children":[]},{"catid":"157","catname":"TV","level":3,"children":[]},{"catid":"158","catname":"Tv accessories","level":3,"children":[]}]}]},{"catid":"232","catname":"Food and Beverage","level":1,"children":[]},{"catid":"233","catname":"Footwear","level":1,"children":[{"catid":"121","catname":"Mens","level":2,"children":[{"catid":"358","catname":"Boots","level":3,"children":[]},{"catid":"359","catname":"Loafer","level":3,"children":[]},{"catid":"360","catname":"Men\'s formal shoes","level":3,"children":[]},{"catid":"361","catname":"Slippers & sandals","level":3,"children":[]},{"catid":"362","catname":"Sneaker & casual","level":3,"children":[]},{"catid":"363","catname":"Sports shoes","level":3,"children":[]}]},{"catid":"122","catname":"Womens","level":2,"children":[{"catid":"364","catname":"Boots","level":3,"children":[]},{"catid":"365","catname":"Flats & sandals","level":3,"children":[]},{"catid":"366","catname":"Heels","level":3,"children":[]},{"catid":"367","catname":"Sneaker","level":3,"children":[]},{"catid":"368","catname":"Traditional wear","level":3,"children":[]}]}]},{"catid":"234","catname":"Health and beauty","level":1,"children":[{"catid":"123","catname":"Cosmetics","level":2,"children":[{"catid":"159","catname":"Eyes","level":3,"children":[]},{"catid":"160","catname":"Face makeup","level":3,"children":[]},{"catid":"161","catname":"Lips","level":3,"children":[]},{"catid":"162","catname":"Nails","level":3,"children":[]}]},{"catid":"124","catname":"Hair Care","level":2,"children":[{"catid":"164","catname":"Hair dryer & straightener","level":3,"children":[]},{"catid":"165","catname":"Other hair care products & Accessories","level":3,"children":[]},{"catid":"166","catname":"Shampoo & Conditioner","level":3,"children":[]},{"catid":"167","catname":"Shaver & Trimmer","level":3,"children":[]}]},{"catid":"125","catname":"Medicine & Health Care","level":2,"children":[{"catid":"168","catname":"Fitness","level":3,"children":[]},{"catid":"169","catname":"Medicine","level":3,"children":[]}]},{"catid":"126","catname":"Perfumes","level":2,"children":[{"catid":"171","catname":"Deodorant","level":3,"children":[]},{"catid":"172","catname":"Men\'s Perfume","level":3,"children":[]},{"catid":"173","catname":"Women\'s perfumes","level":3,"children":[]}]},{"catid":"127","catname":"Skin care","level":2,"children":[{"catid":"174","catname":"Bath and body care","level":3,"children":[]},{"catid":"175","catname":"Facial care","level":3,"children":[]}]}]},{"catid":"235","catname":"Home & Living","level":1,"children":[{"catid":"128","catname":"Furniture","level":2,"children":[{"catid":"177","catname":"Bedroom furniture","level":3,"children":[]},{"catid":"178","catname":"Dining room furniture","level":3,"children":[]},{"catid":"179","catname":"Livingroom Furniture","level":3,"children":[]},{"catid":"180","catname":"Offfice furniture","level":3,"children":[]},{"catid":"181","catname":"Outdoor furniture","level":3,"children":[]}]},{"catid":"129","catname":"Gardening","level":2,"children":[]},{"catid":"130","catname":"Home Appliances","level":2,"children":[{"catid":"182","catname":"Air Conditioner","level":3,"children":[]},{"catid":"183","catname":"Electric Fan","level":3,"children":[]},{"catid":"184","catname":"Heater","level":3,"children":[]},{"catid":"185","catname":"Insect killer","level":3,"children":[]},{"catid":"186","catname":"Irons","level":3,"children":[]},{"catid":"187","catname":"Lighting and Generator","level":3,"children":[]},{"catid":"188","catname":"Telephones","level":3,"children":[]},{"catid":"189","catname":"Tools","level":3,"children":[]},{"catid":"190","catname":"Vaccum cleaner","level":3,"children":[]},{"catid":"191","catname":"Washing Machine","level":3,"children":[]}]},{"catid":"131","catname":"Home decor","level":2,"children":[{"catid":"192","catname":"Bathroom accessories","level":3,"children":[]},{"catid":"193","catname":"Carpet rugs mats","level":3,"children":[]},{"catid":"194","catname":"Clock","level":3,"children":[]},{"catid":"195","catname":"Curtains","level":3,"children":[]},{"catid":"196","catname":"Decoration pieces","level":3,"children":[]},{"catid":"197","catname":"Painting & Poster","level":3,"children":[]},{"catid":"198","catname":"Pillow and bedsheet","level":3,"children":[]}]},{"catid":"132","catname":"Kitchen & Dining","level":2,"children":[{"catid":"199","catname":"Blender & Mixer","level":3,"children":[]},{"catid":"200","catname":"Coffee machine & Accessories","level":3,"children":[]},{"catid":"201","catname":"Crockery","level":3,"children":[]},{"catid":"202","catname":"Cutlery","level":3,"children":[]},{"catid":"203","catname":"Electric kettle","level":3,"children":[]},{"catid":"204","catname":"Kitchen accessories","level":3,"children":[]},{"catid":"205","catname":"Microwave oven","level":3,"children":[]},{"catid":"206","catname":"Refrigerator and freezers","level":3,"children":[]},{"catid":"207","catname":"Water Dispencer","level":3,"children":[]}]}]},{"catid":"236","catname":"Jewellery","level":1,"children":[{"catid":"133","catname":"Bangels and Bracelets","level":2,"children":[]},{"catid":"134","catname":"Earring","level":2,"children":[]},{"catid":"135","catname":"Jwellery Set","level":2,"children":[]},{"catid":"136","catname":"Necklace","level":2,"children":[]},{"catid":"137","catname":"Rings","level":2,"children":[]}]},{"catid":"237","catname":"Mobiles & Tablets","level":1,"children":[{"catid":"138","catname":"Cases","level":2,"children":[]},{"catid":"139","catname":"Charger,BAtteries etc","level":2,"children":[]},{"catid":"140","catname":"Mobile","level":2,"children":[]},{"catid":"141","catname":"Tabs","level":2,"children":[]}]},{"catid":"238","catname":"Other Catagories","level":1,"children":[{"catid":"142","catname":"Appliance","level":2,"children":[]},{"catid":"143","catname":"Building Materials","level":2,"children":[]},{"catid":"144","catname":"Collectibles","level":2,"children":[{"catid":"208","catname":"Cigarettes & Lighters","level":3,"children":[]},{"catid":"210","catname":"GPs & Vehicle Accessories","level":3,"children":[]},{"catid":"211","catname":"Pet Supplies","level":3,"children":[]},{"catid":"212","catname":"Safety Equipment","level":3,"children":[]}]},{"catid":"145","catname":"Everything else","level":2,"children":[]},{"catid":"146","catname":"Musical Instruments","level":2,"children":[]},{"catid":"147","catname":"Office & School","level":2,"children":[{"catid":"214","catname":"Calculators","level":3,"children":[]},{"catid":"216","catname":"Office & School Accessories","level":3,"children":[]}]},{"catid":"262","catname":"Art","level":2,"children":[]}]},{"catid":"239","catname":"Sports & Outdoors","level":1,"children":[{"catid":"148","catname":"Cricket","level":2,"children":[]},{"catid":"149","catname":"Fitness equipment","level":2,"children":[]},{"catid":"150","catname":"Football","level":2,"children":[]},{"catid":"151","catname":"Outdoor games and accessories","level":2,"children":[]},{"catid":"152","catname":"Sports Accesories","level":2,"children":[]},{"catid":"153","catname":"Sports Clothing","level":2,"children":[]},{"catid":"154","catname":"Sports shoes","level":2,"children":[]}]},{"catid":"240","catname":"Toys, Kids & Babies","level":1,"children":[{"catid":"155","catname":"Action Figures","level":2,"children":[]},{"catid":"156","catname":"Baby accesories","level":2,"children":[]},{"catid":"157","catname":"Baby food","level":2,"children":[]},{"catid":"158","catname":"Baby products","level":2,"children":[]},{"catid":"159","catname":"Board games and Puzzels","level":2,"children":[]},{"catid":"160","catname":"Dolls and stuffed toys","level":2,"children":[]},{"catid":"161","catname":"Gifts","level":2,"children":[]},{"catid":"162","catname":"Other toys","level":2,"children":[]},{"catid":"163","catname":"Pregnancy and maternity","level":2,"children":[]},{"catid":"263","catname":"Car","level":2,"children":[]}]},{"catid":"258","catname":"Service","level":1,"children":[{"catid":"265","catname":"Catering Service","level":2,"children":[]},{"catid":"264","catname":"Event Management","level":2,"children":[]},{"catid":"266","catname":"Consultency","level":2,"children":[]},{"catid":"267","catname":"Food & Restaurant","level":2,"children":[]},{"catid":"268","catname":"Travelling","level":2,"children":[{"catid":"371","catname":"Travel Agents","level":3,"children":[]},{"catid":"370","catname":"Tickets & Bookings","level":3,"children":[]},{"catid":"369","catname":"Hotels","level":3,"children":[]}]},{"catid":"269","catname":"Photography","level":2,"children":[]},{"catid":"270","catname":"Training & Developement","level":2,"children":[]}]},{"catid":"242","catname":"Watches","level":1,"children":[{"catid":"167","catname":"Female","level":2,"children":[{"catid":"217","catname":"Designer Watches","level":3,"children":[]},{"catid":"218","catname":"Regular Watch","level":3,"children":[]},{"catid":"219","catname":"Smartwatch","level":3,"children":[]}]},{"catid":"168","catname":"Male","level":2,"children":[{"catid":"220","catname":"Designer Watches","level":3,"children":[]},{"catid":"221","catname":"Regular Watch","level":3,"children":[]},{"catid":"222","catname":"Smartwatch","level":3,"children":[]}]}]},{"catid":"259","catname":"Bag","level":1,"children":[]},{"catid":"260","catname":"Glasses","level":1,"children":[{"catid":"271","catname":"For Men","level":2,"children":[]},{"catid":"272","catname":"For Women","level":2,"children":[]}]},{"catid":"261","catname":"Lifestyle","level":1,"children":[]},{"catid":"262","catname":"Combo","level":1,"children":[]},{"catid":"263","catname":"Flowers","level":1,"children":[]}]';
        return $catjson;
        // return json_encode($cattree);
    }
    public function getCategoriesByID($shopID){
        header("content-type : application/javascript");
        // dd($shopID);
        $tree = array();
        if ($shopID) {
            $categories = DB::table('shops')
            ->join('products', 'shops.id', '=', 'products.shop_id')
            ->join('categories', 'products.category_id', '=', 'categories.id')
            ->leftJoin('subcategories', 'products.subcategory_id', '=', 'subcategories.id')
            ->leftJoin('subsubcategories', 'products.subSubCategory_id', '=', 'subsubcategories.id')
            ->select('products.category_id', 'categories.name AS category_name', 'products.subcategory_id',
                'subcategories.name AS subcategory_name',
                'products.subSubCategory_id',
                'subsubcategories.name AS subsubcategory_name')
            ->where('shops.id', '=', $shopID)
            ->groupBy('category_id', 'subcategory_id', 'subSubCategory_id')
            ->get();
            $lastCatID = $lastSubCatID = $lastKey = '';

            // Pure magic.
            foreach ($categories as $key => $value) {
                $subsubchildren = $value->subSubCategory_id > 0 ? array($value->subSubCategory_id => array('catid' => $value->subSubCategory_id,'catname' => $value->subsubcategory_name,'level' => 3, 'children'=> array() ) ): array();
                if ($lastCatID != $value->category_id) {
                    $tree[$value->category_id]  = array('catid' => $value->category_id,
                                        'level' => 1,
                                        'catname' => $value->category_name,
                                        'children' =>  $value->subcategory_id > 0 ? array($value->subcategory_id => array('catid' => $value->subcategory_id,'catname' => $value->subcategory_name,'level' => 2,'children' => $subsubchildren) ): array() );
                    $lastKey = $value->category_id;
                    $lastSubKey = $value->subcategory_id;
                    // var_dump('$lastKey'.$lastKey);
                }
                else {
                    // var_dump($tree[$lastKey]);
                    if ($lastSubCatID != $value->subcategory_id) {
                        $tree[$lastKey]['children'][$value->subcategory_id] = $value->subcategory_id > 0 ? array('catid' => $value->subcategory_id,'catname' => $value->subcategory_name,'level' => 2,'children' => $subsubchildren): array();
                        $lastSubKey = $value->subcategory_id;
                        // var_dump('$lastKey'.$lastKey);
                        // var_dump('$lastSubKey'.$lastSubKey);
                    }
                    else {
                        $tree[$lastKey]['children'][$lastSubKey]['children'][$value->subSubCategory_id] = $value->subSubCategory_id > 0 ? array('catid' => $value->subSubCategory_id,'catname' => $value->subsubcategory_name,'level' => 3, 'children'=> array() ): array();
                        // var_dump('$lastKey'.$lastKey);
                        // var_dump('$lastSubKey'.$lastSubKey);
                    }

                
                }
                $lastCatID = $value->category_id;
                $lastSubCatID = $value->subcategory_id;
                
            }

            // echo( json_encode($tree) );
            if(!empty($_GET['callback']))
            return $_GET['callback'].'('.json_encode($tree).')';
            else
            return json_encode($tree);

            // return Response::json($tree);
        } else {
            
            return 'Sorry! Something is wrong with this account!';
        }
        

/*        "SELECT
shops.title,
products.category_id,
categories.name AS category_name,
products.subcategory_id,
subcategories.name AS subcategory_name,
products.subsubcategory_id,
subsubcategories.name AS subsubcategory_name
FROM shops
JOIN products ON shops.id = products.shop_id
JOIN categories ON products.category_id = categories.id
left JOIN subcategories ON products.subcategory_id = subcategories.id
left JOIN subsubcategories ON products.subsubcategory_id = subsubcategories.id
WHERE
shops.id = 6
GROUP BY category_id, subcategory_id, subsubcategory_id"*/
        
    }

}

